{"ast":null,"code":"var _jsxFileName = \"/home/quan/Downloads/g/goodpicker-main/frontend/src/pages/chat/index.js\",\n    _s = $RefreshSig$();\n\nimport './style.scss';\nimport React from 'react';\nimport axios from 'axios';\nimport WebSocketInstance from '../../service/websocket';\nimport SiteLayout from '../../components/layouts/site-layout';\nimport { useAuthState } from '../../hooks/useAuth';\nimport TimeAgo from 'javascript-time-ago';\nimport { Link, useHistory, useParams } from 'react-router-dom';\nimport { Form, Input, Avatar, Row, Col } from 'antd';\nimport { SendOutlined } from '@ant-design/icons';\nimport { jsxDEV as _jsxDEV } from \"react/jsx-dev-runtime\";\n\nconst Chat = () => {\n  _s();\n\n  const {\n    user,\n    cookies\n  } = useAuthState();\n  const timeAgo = new TimeAgo('vi-VN');\n  const {\n    chatID\n  } = useParams();\n  const prevChatIDRef = React.useRef(null);\n  const messageBoxRef = React.useRef(null);\n  const unmountedRef = React.useRef(false);\n  const inputRef = React.useRef(null);\n  const [messages, setMessages] = React.useState([]);\n  const history = useHistory();\n  const [form] = Form.useForm();\n  const addMessage = React.useCallback(message => {\n    setMessages([...messages, message]);\n  }, [messages]);\n  const waitForSocketConnection = React.useCallback(() => {\n    setTimeout(() => {\n      if (WebSocketInstance.state() === 1) {\n        return;\n      } else {\n        waitForSocketConnection();\n      }\n    }, 100);\n  }, []);\n  React.useLayoutEffect(() => {\n    messageBoxRef.current.scrollTop = messageBoxRef.current.scrollHeight;\n  });\n  React.useEffect(() => {\n    WebSocketInstance.addCallbacks(addMessage);\n  }, [addMessage]);\n  React.useEffect(() => {\n    if (!user || !cookies['gp_token']) {\n      history.push('/');\n    } else {\n      unmountedRef.current = false;\n\n      const checkIfParticipants = async () => {\n        try {\n          const res = await axios.get(`/api/chats/${chatID}`, {\n            headers: {\n              Authorization: `Bearer ${cookies['gp_token']}`\n            }\n          });\n\n          if (prevChatIDRef.current !== chatID) {\n            if (prevChatIDRef.current != null) {\n              WebSocketInstance.disconnect();\n            }\n\n            waitForSocketConnection();\n            WebSocketInstance.connect(chatID);\n            prevChatIDRef.current = chatID;\n          }\n\n          if (!unmountedRef.current) {\n            console.log(res.data.messages);\n            setMessages(res.data.messages);\n          }\n        } catch (e) {\n          history.push('/');\n        }\n      };\n\n      checkIfParticipants();\n    }\n\n    return () => {\n      WebSocketInstance.disconnect();\n      unmountedRef.current = true;\n    };\n  }, [chatID, cookies, history, user, waitForSocketConnection]);\n\n  const sendMessageHandler = value => {\n    if (value.message) {\n      const messageObject = {\n        from: user.username,\n        content: value.message,\n        chatId: chatID\n      };\n      WebSocketInstance.newChatMessage(messageObject);\n      form.resetFields();\n      inputRef.current.focus();\n    }\n  };\n\n  const renderContacts = () => {\n    return user.contacts.map(_ref => {\n      let {\n        partner,\n        chatId\n      } = _ref;\n      return /*#__PURE__*/_jsxDEV(Link, {\n        className: `chatpage-contact${Number(chatId) === Number(chatID) ? ' chatpage-contact--active' : ''}`,\n        to: `/chat/${chatId}`,\n        children: [partner.userImage ? /*#__PURE__*/_jsxDEV(Avatar, {\n          size: \"large\",\n          src: partner.userImage,\n          className: \"chatpage-contact__avatar\"\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 113,\n          columnNumber: 6\n        }, this) : /*#__PURE__*/_jsxDEV(Avatar, {\n          size: \"large\",\n          className: \"chatpage-contact__avatar chatpage-contact__avatar--default\",\n          children: partner.username[0].toUpperCase()\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 119,\n          columnNumber: 6\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"chatpage-contact__name\",\n          children: partner.username\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 126,\n          columnNumber: 5\n        }, this)]\n      }, `${partner.username}${chatId}`, true, {\n        fileName: _jsxFileName,\n        lineNumber: 105,\n        columnNumber: 4\n      }, this);\n    });\n  };\n\n  const renderMessages = () => {\n    return messages.map(message => {\n      var _message$author, _message$author2;\n\n      return /*#__PURE__*/_jsxDEV(\"div\", {\n        className: `chatpage-message chatpage-message${user.username === ((_message$author = message.author) !== null && _message$author !== void 0 ? _message$author : message.user.username) ? '--right' : ''}`,\n        children: [/*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"chatpage-message__content\",\n          children: message.content\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 141,\n          columnNumber: 5\n        }, this), /*#__PURE__*/_jsxDEV(\"div\", {\n          className: \"chatpage-message__ago\",\n          children: timeAgo.format(Date.now() - (new Date() - new Date(message.timestamp)))\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 143,\n          columnNumber: 5\n        }, this)]\n      }, `${(_message$author2 = message.author) !== null && _message$author2 !== void 0 ? _message$author2 : message.user.username}${message.timestamp}`, true, {\n        fileName: _jsxFileName,\n        lineNumber: 133,\n        columnNumber: 4\n      }, this);\n    });\n  };\n\n  return /*#__PURE__*/_jsxDEV(SiteLayout, {\n    children: /*#__PURE__*/_jsxDEV(\"div\", {\n      className: \"chatpage\",\n      children: /*#__PURE__*/_jsxDEV(Row, {\n        className: \"chatpage-row\",\n        children: [/*#__PURE__*/_jsxDEV(Col, {\n          xs: 24,\n          md: 5,\n          className: \"chatpage-contact-list\",\n          children: user && renderContacts()\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 156,\n          columnNumber: 6\n        }, this), /*#__PURE__*/_jsxDEV(Col, {\n          xs: 20,\n          md: 14,\n          className: \"chatpage-main\",\n          children: [/*#__PURE__*/_jsxDEV(\"div\", {\n            id: \"messageList\",\n            className: \"chatpage-message-list\",\n            ref: messageBoxRef,\n            children: user && renderMessages()\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 161,\n            columnNumber: 7\n          }, this), /*#__PURE__*/_jsxDEV(Form, {\n            form: form,\n            className: \"chatpage-input\",\n            layout: \"inline\",\n            onFinish: sendMessageHandler,\n            children: [/*#__PURE__*/_jsxDEV(Form.Item, {\n              name: \"message\",\n              children: /*#__PURE__*/_jsxDEV(Input, {\n                ref: inputRef,\n                placeholder: \"G\\u1EEDi tin nh\\u1EAFn\"\n              }, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 176,\n                columnNumber: 9\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 175,\n              columnNumber: 8\n            }, this), /*#__PURE__*/_jsxDEV(\"button\", {\n              type: \"submit\",\n              children: /*#__PURE__*/_jsxDEV(SendOutlined, {}, void 0, false, {\n                fileName: _jsxFileName,\n                lineNumber: 180,\n                columnNumber: 9\n              }, this)\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 179,\n              columnNumber: 8\n            }, this)]\n          }, void 0, true, {\n            fileName: _jsxFileName,\n            lineNumber: 169,\n            columnNumber: 7\n          }, this)]\n        }, void 0, true, {\n          fileName: _jsxFileName,\n          lineNumber: 160,\n          columnNumber: 6\n        }, this), /*#__PURE__*/_jsxDEV(Col, {\n          xs: 4,\n          md: 5,\n          children: /*#__PURE__*/_jsxDEV(\"div\", {\n            className: \"chatpage-link-list\",\n            children: /*#__PURE__*/_jsxDEV(Link, {\n              className: \"chatpage-link\",\n              to: `/users/${user.contacts.find(contact => Number(contact.chatId) === Number(chatID)).partner.id}`,\n              children: \"Xem trang c\\xE1 nh\\xE2n\"\n            }, void 0, false, {\n              fileName: _jsxFileName,\n              lineNumber: 187,\n              columnNumber: 8\n            }, this)\n          }, void 0, false, {\n            fileName: _jsxFileName,\n            lineNumber: 186,\n            columnNumber: 7\n          }, this)\n        }, void 0, false, {\n          fileName: _jsxFileName,\n          lineNumber: 185,\n          columnNumber: 6\n        }, this)]\n      }, void 0, true, {\n        fileName: _jsxFileName,\n        lineNumber: 155,\n        columnNumber: 5\n      }, this)\n    }, void 0, false, {\n      fileName: _jsxFileName,\n      lineNumber: 154,\n      columnNumber: 4\n    }, this)\n  }, void 0, false, {\n    fileName: _jsxFileName,\n    lineNumber: 153,\n    columnNumber: 3\n  }, this);\n};\n\n_s(Chat, \"HNL2WAVt3m0KVlkzroh2QWBMu2s=\", false, function () {\n  return [useAuthState, useParams, useHistory, Form.useForm];\n});\n\n_c = Chat;\nexport default Chat;\n\nvar _c;\n\n$RefreshReg$(_c, \"Chat\");","map":{"version":3,"sources":["/home/quan/Downloads/g/goodpicker-main/frontend/src/pages/chat/index.js"],"names":["React","axios","WebSocketInstance","SiteLayout","useAuthState","TimeAgo","Link","useHistory","useParams","Form","Input","Avatar","Row","Col","SendOutlined","Chat","user","cookies","timeAgo","chatID","prevChatIDRef","useRef","messageBoxRef","unmountedRef","inputRef","messages","setMessages","useState","history","form","useForm","addMessage","useCallback","message","waitForSocketConnection","setTimeout","state","useLayoutEffect","current","scrollTop","scrollHeight","useEffect","addCallbacks","push","checkIfParticipants","res","get","headers","Authorization","disconnect","connect","console","log","data","e","sendMessageHandler","value","messageObject","from","username","content","chatId","newChatMessage","resetFields","focus","renderContacts","contacts","map","partner","Number","userImage","toUpperCase","renderMessages","author","format","Date","now","timestamp","find","contact","id"],"mappings":"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","sourcesContent":["import './style.scss'\n\nimport React from 'react'\nimport axios from 'axios'\nimport WebSocketInstance from '../../service/websocket'\nimport SiteLayout from '../../components/layouts/site-layout'\nimport { useAuthState } from '../../hooks/useAuth'\nimport TimeAgo from 'javascript-time-ago'\nimport { Link, useHistory, useParams } from 'react-router-dom'\nimport { Form, Input, Avatar, Row, Col } from 'antd'\nimport { SendOutlined } from '@ant-design/icons'\n\nconst Chat = () => {\n\tconst { user, cookies } = useAuthState()\n\tconst timeAgo = new TimeAgo('vi-VN')\n\tconst { chatID } = useParams()\n\tconst prevChatIDRef = React.useRef(null)\n\tconst messageBoxRef = React.useRef(null)\n\tconst unmountedRef = React.useRef(false)\n\tconst inputRef = React.useRef(null)\n\tconst [messages, setMessages] = React.useState([])\n\tconst history = useHistory()\n\tconst [form] = Form.useForm()\n\n\tconst addMessage = React.useCallback(\n\t\tmessage => {\n\t\t\tsetMessages([...messages, message])\n\t\t},\n\t\t[messages]\n\t)\n\n\tconst waitForSocketConnection = React.useCallback(() => {\n\t\tsetTimeout(() => {\n\t\t\tif (WebSocketInstance.state() === 1) {\n\t\t\t\treturn\n\t\t\t} else {\n\t\t\t\twaitForSocketConnection()\n\t\t\t}\n\t\t}, 100)\n\t}, [])\n\n\tReact.useLayoutEffect(() => {\n\t\tmessageBoxRef.current.scrollTop = messageBoxRef.current.scrollHeight\n\t})\n\n\tReact.useEffect(() => {\n\t\tWebSocketInstance.addCallbacks(addMessage)\n\t}, [addMessage])\n\n\tReact.useEffect(() => {\n\t\tif (!user || !cookies['gp_token']) {\n\t\t\thistory.push('/')\n\t\t} else {\n\t\t\tunmountedRef.current = false\n\t\t\tconst checkIfParticipants = async () => {\n\t\t\t\ttry {\n\t\t\t\t\tconst res = await axios.get(`/api/chats/${chatID}`, {\n\t\t\t\t\t\theaders: {\n\t\t\t\t\t\t\tAuthorization: `Bearer ${cookies['gp_token']}`\n\t\t\t\t\t\t}\n\t\t\t\t\t})\n\n\t\t\t\t\tif (prevChatIDRef.current !== chatID) {\n\t\t\t\t\t\tif (prevChatIDRef.current != null) {\n\t\t\t\t\t\t\tWebSocketInstance.disconnect()\n\t\t\t\t\t\t}\n\t\t\t\t\t\twaitForSocketConnection()\n\t\t\t\t\t\tWebSocketInstance.connect(chatID)\n\t\t\t\t\t\tprevChatIDRef.current = chatID\n\t\t\t\t\t}\n\n\t\t\t\t\tif (!unmountedRef.current) {\n\t\t\t\t\t\tconsole.log(res.data.messages)\n\t\t\t\t\t\tsetMessages(res.data.messages)\n\t\t\t\t\t}\n\t\t\t\t} catch (e) {\n\t\t\t\t\thistory.push('/')\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tcheckIfParticipants()\n\t\t}\n\n\t\treturn () => {\n\t\t\tWebSocketInstance.disconnect()\n\t\t\tunmountedRef.current = true\n\t\t}\n\t}, [chatID, cookies, history, user, waitForSocketConnection])\n\n\tconst sendMessageHandler = value => {\n\t\tif (value.message) {\n\t\t\tconst messageObject = {\n\t\t\t\tfrom: user.username,\n\t\t\t\tcontent: value.message,\n\t\t\t\tchatId: chatID\n\t\t\t}\n\t\t\tWebSocketInstance.newChatMessage(messageObject)\n\t\t\tform.resetFields()\n\t\t\tinputRef.current.focus()\n\t\t}\n\t}\n\n\tconst renderContacts = () => {\n\t\treturn user.contacts.map(({ partner, chatId }) => (\n\t\t\t<Link\n\t\t\t\tkey={`${partner.username}${chatId}`}\n\t\t\t\tclassName={`chatpage-contact${\n\t\t\t\t\tNumber(chatId) === Number(chatID) ? ' chatpage-contact--active' : ''\n\t\t\t\t}`}\n\t\t\t\tto={`/chat/${chatId}`}\n\t\t\t>\n\t\t\t\t{partner.userImage ? (\n\t\t\t\t\t<Avatar\n\t\t\t\t\t\tsize=\"large\"\n\t\t\t\t\t\tsrc={partner.userImage}\n\t\t\t\t\t\tclassName=\"chatpage-contact__avatar\"\n\t\t\t\t\t/>\n\t\t\t\t) : (\n\t\t\t\t\t<Avatar\n\t\t\t\t\t\tsize=\"large\"\n\t\t\t\t\t\tclassName=\"chatpage-contact__avatar chatpage-contact__avatar--default\"\n\t\t\t\t\t>\n\t\t\t\t\t\t{partner.username[0].toUpperCase()}\n\t\t\t\t\t</Avatar>\n\t\t\t\t)}\n\t\t\t\t<div className=\"chatpage-contact__name\">{partner.username}</div>\n\t\t\t</Link>\n\t\t))\n\t}\n\n\tconst renderMessages = () => {\n\t\treturn messages.map(message => (\n\t\t\t<div\n\t\t\t\tclassName={`chatpage-message chatpage-message${\n\t\t\t\t\tuser.username === (message.author ?? message.user.username)\n\t\t\t\t\t\t? '--right'\n\t\t\t\t\t\t: ''\n\t\t\t\t}`}\n\t\t\t\tkey={`${message.author ?? message.user.username}${message.timestamp}`}\n\t\t\t>\n\t\t\t\t<div className=\"chatpage-message__content\">{message.content}</div>\n\n\t\t\t\t<div className=\"chatpage-message__ago\">\n\t\t\t\t\t{timeAgo.format(\n\t\t\t\t\t\tDate.now() - (new Date() - new Date(message.timestamp))\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t))\n\t}\n\n\treturn (\n\t\t<SiteLayout>\n\t\t\t<div className=\"chatpage\">\n\t\t\t\t<Row className=\"chatpage-row\">\n\t\t\t\t\t<Col xs={24} md={5} className=\"chatpage-contact-list\">\n\t\t\t\t\t\t{user && renderContacts()}\n\t\t\t\t\t</Col>\n\n\t\t\t\t\t<Col xs={20} md={14} className=\"chatpage-main\">\n\t\t\t\t\t\t<div\n\t\t\t\t\t\t\tid=\"messageList\"\n\t\t\t\t\t\t\tclassName=\"chatpage-message-list\"\n\t\t\t\t\t\t\tref={messageBoxRef}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{user && renderMessages()}\n\t\t\t\t\t\t</div>\n\n\t\t\t\t\t\t<Form\n\t\t\t\t\t\t\tform={form}\n\t\t\t\t\t\t\tclassName=\"chatpage-input\"\n\t\t\t\t\t\t\tlayout=\"inline\"\n\t\t\t\t\t\t\tonFinish={sendMessageHandler}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<Form.Item name=\"message\">\n\t\t\t\t\t\t\t\t<Input ref={inputRef} placeholder=\"Gửi tin nhắn\" />\n\t\t\t\t\t\t\t</Form.Item>\n\n\t\t\t\t\t\t\t<button type=\"submit\">\n\t\t\t\t\t\t\t\t<SendOutlined />\n\t\t\t\t\t\t\t</button>\n\t\t\t\t\t\t</Form>\n\t\t\t\t\t</Col>\n\n\t\t\t\t\t<Col xs={4} md={5}>\n\t\t\t\t\t\t<div className=\"chatpage-link-list\">\n\t\t\t\t\t\t\t<Link\n\t\t\t\t\t\t\t\tclassName=\"chatpage-link\"\n\t\t\t\t\t\t\t\tto={`/users/${\n\t\t\t\t\t\t\t\t\tuser.contacts.find(\n\t\t\t\t\t\t\t\t\t\tcontact => Number(contact.chatId) === Number(chatID)\n\t\t\t\t\t\t\t\t\t).partner.id\n\t\t\t\t\t\t\t\t}`}\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\tXem trang cá nhân\n\t\t\t\t\t\t\t</Link>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</Col>\n\t\t\t\t</Row>\n\t\t\t</div>\n\t\t</SiteLayout>\n\t)\n}\n\nexport default Chat\n"]},"metadata":{},"sourceType":"module"}